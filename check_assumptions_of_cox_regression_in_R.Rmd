---
title: "check assumption of cox regression"
---
reference: https://www.coursera.org/learn/survival-analysis-r-public-health/supplement/5wr8w/feedback-on-practice-quiz

Preparation:
```{r}
library(survival)
library(survminer)
```


```{r}
data_link = 'https://raw.githubusercontent.com/AilingLiu/Survival_analysis/master/Data/simulated%20HF%20mort%20data%20for%20GMPH%20(1K)%20final.csv'

hf =read.csv(data_link)
head(hf)

```

Build a cox regression model with gender as predictor

```{r}
fit <- coxph(Surv(fu_time, death) ~ gender, data=hf) # fit the desired model

temp <- cox.zph(fit)# apply the cox.zph function to the desired model

print(temp, digits = 4) # display the results
```

The pvalue is higher than the conventional 0.05, meaning there is no evidence that time and residuals are related. 

```{r}
ggcoxzph(temp) # plot the curves
```

Technically speaking, the function cox.zph() correlates for each predictor the corresponding set of scaled Schoenfeld residuals with time, to test for independence between residuals and time. From this plot, it proves the statistics above for no relation between time and residuals.

#KM plot for gender
```{r}
km_fit <- survfit(Surv(fu_time, death) ~ gender, data=hf) 

plot(km_fit, xlab = "time", ylab = "Survival probability") # label the axes 

```

The lines give the survival probability for each gender at each time point. This plot is very no-frills, but in this instance it does the job - it's pretty clear that the two lines are pretty parallel over time throughout the follow-up period, though in this instance the fact that they're almost on top of one another makes it easy to judge.

# Use martingale residuals against covariate to look for outliers 
```{r}
res.cox <- coxph(Surv(fu_time, death) ~ age, data=hf) 
ggcoxdiagnostics(res.cox, type = "dfbeta", 
                 linear.predictions = FALSE, ggtheme = theme_bw()) 
```

The residuals are sitting around 0


Check outliers with standardized martingale residuals, for data points outside of [-1.96, 1.96], they are potentional outliers (5% of normal distribution)
```{r}
res.cox <- coxph(Surv(fu_time, death) ~ age, data=hf) 
ggcoxdiagnostics(res.cox, type = "deviance", 
                 linear.predictions = FALSE, ggtheme = theme_bw()) 
```

The deviance residuals, which are normalized transformations of the martingale residual and should be roughly symmetrically distributed about zero with a standard deviation of 1. In normal distribution, 5% of observations are more than 1.96 standard deviations from the mean. So if the SD is 1, then only 5% of observations should be bigger than 1.96 or more negative than -1.96. If we observe more than that proportion, then the model doesn't fit the data as well as it should and some observations are a problem. 


# check linearity between predictor and outcome
```{r}
ggcoxfunctional(Surv(fu_time, death) ~ age + log(age) + sqrt(age), data=hf) 
```

ggcoxfunctional() is part of the survminer R package. Martingale residuals may present any value between minus infinity and 1) and have a mean of zero:

Martingale residuals near 1 represent individuals that "died too soon"
Large negative values correspond to individuals that "lived too long"
The plots should give you nice straight line if the assumption is valid.